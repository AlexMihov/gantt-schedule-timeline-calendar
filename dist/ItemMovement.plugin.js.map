{"version":3,"file":"ItemMovement.plugin.js","sources":["../src/plugins/TimelinePointer.plugin.ts","../src/plugins/ItemMovement.plugin.ts"],"sourcesContent":["/**\n * TimelinePointer plugin\n *\n * @copyright Rafal Pospiech <https://neuronet.io>\n * @author    Rafal Pospiech <neuronet.io@gmail.com>\n * @package   gantt-schedule-timeline-calendar\n * @license   AGPL-3.0 (https://github.com/neuronetio/gantt-schedule-timeline-calendar/blob/master/LICENSE)\n * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar\n */\n\nimport { vido } from '@neuronet.io/vido/vido';\nimport DeepState from 'deep-state-observer';\nimport { Api } from '../api/Api';\n\nexport const CELL = 'chart-timeline-grid-row-cell';\nexport const ITEM = 'chart-timeline-items-row-item';\n\nexport interface PointerEvents {\n  down: PointerEvent | null;\n  move: PointerEvent | null;\n  up: PointerEvent | null;\n}\n\nexport interface Point {\n  x: number;\n  y: number;\n}\n\nexport type PointerState = 'up' | 'down' | 'move';\n\nexport interface PluginData {\n  enabled: boolean;\n  isMoving: boolean;\n  pointerState: PointerState;\n  currentTarget: HTMLElement | null;\n  realTarget: HTMLElement | null;\n  targetType: 'chart-timeline-items-row-item' | 'chart-timeline-grid-row-cell' | '';\n  targetData: any | null;\n  events: PointerEvents;\n  initialPosition: Point;\n  currentPosition: Point;\n}\n\nexport function Plugin(options = { enabled: true }) {\n  let vido: vido<DeepState, Api>, api: Api, state: DeepState;\n  const pluginPath = 'config.plugin.TimelinePointer';\n\n  const classNames = {\n    cell: '',\n    item: ''\n  };\n\n  function generateEmptyData(): PluginData {\n    return {\n      enabled: options.enabled,\n      isMoving: false,\n      pointerState: 'up',\n      currentTarget: null,\n      realTarget: null,\n      targetType: '',\n      targetData: null,\n      initialPosition: { x: 0, y: 0 },\n      currentPosition: { x: 0, y: 0 },\n      events: {\n        down: null,\n        move: null,\n        up: null\n      }\n    };\n  }\n\n  let chartTimelineElement: HTMLElement;\n\n  class TimelinePointerAction {\n    private data: PluginData;\n    private unsub = [];\n\n    constructor(element) {\n      this.pointerDown = this.pointerDown.bind(this);\n      this.pointerMove = this.pointerMove.bind(this);\n      this.pointerUp = this.pointerUp.bind(this);\n      this.data = generateEmptyData();\n      element.addEventListener('pointerdown', this.pointerDown);\n      document.addEventListener('pointerup', this.pointerUp);\n      document.addEventListener('pointermove', this.pointerMove);\n      this.unsub.push(state.subscribe(pluginPath, value => (this.data = value)));\n    }\n\n    public destroy(element) {\n      element.removeEventListener('pointerdown', this.pointerDown);\n      document.removeEventListener('pointerup', this.pointerUp);\n      document.removeEventListener('pointermove', this.pointerMove);\n    }\n\n    private updateData() {\n      state.update(pluginPath, () => ({ ...this.data }));\n    }\n\n    private getRealTarget(ev: PointerEvent) {\n      let realTarget: HTMLElement = (ev.target as HTMLElement).closest('.' + classNames.item) as HTMLElement;\n      if (realTarget) {\n        return realTarget;\n      }\n      realTarget = (ev.target as HTMLElement).closest('.' + classNames.cell) as HTMLElement;\n      if (realTarget) {\n        return realTarget;\n      }\n      return null;\n    }\n\n    getRealPosition(ev: PointerEvent): Point {\n      const pos = { x: 0, y: 0 };\n      if (chartTimelineElement) {\n        const bounding = chartTimelineElement.getBoundingClientRect();\n        pos.x = ev.x - bounding.x;\n        pos.y = ev.y - bounding.y;\n      }\n      return pos;\n    }\n\n    private pointerDown(ev: PointerEvent) {\n      if (!this.data.enabled) return;\n      this.data.pointerState = 'down';\n      this.data.currentTarget = ev.target as HTMLElement;\n      this.data.realTarget = this.getRealTarget(ev);\n      if (this.data.realTarget) {\n        if (this.data.realTarget.classList.contains(classNames.item)) {\n          this.data.targetType = ITEM;\n          // @ts-ignore\n          this.data.targetData = this.data.realTarget.vido.item;\n        } else if (this.data.realTarget.classList.contains(classNames.cell)) {\n          this.data.targetType = CELL;\n          // @ts-ignore\n          this.data.targetData = this.data.realTarget.vido;\n        } else {\n          this.data.targetType = '';\n        }\n      } else {\n        this.data.targetType = '';\n        this.data.targetData = null;\n      }\n      this.data.isMoving = !!this.data.realTarget;\n      this.data.events.down = ev;\n      this.data.events.move = ev;\n      const realPosition = this.getRealPosition(ev);\n      this.data.initialPosition = realPosition;\n      this.data.currentPosition = realPosition;\n      this.updateData();\n    }\n\n    private pointerUp(ev: PointerEvent) {\n      if (!this.data.enabled) return;\n      this.data.pointerState = 'up';\n      this.data.isMoving = false;\n      this.data.events.up = ev;\n      this.data.currentPosition = this.getRealPosition(ev);\n      this.updateData();\n    }\n\n    private pointerMove(ev: PointerEvent) {\n      if (!this.data.enabled || !this.data.isMoving) return;\n      this.data.pointerState = 'move';\n      this.data.events.move = ev;\n      this.data.currentPosition = this.getRealPosition(ev);\n      this.updateData();\n    }\n  }\n\n  return function initialize(vidoInstance: vido<DeepState, Api>) {\n    vido = vidoInstance;\n    api = vido.api;\n    state = vido.state;\n    classNames.cell = api.getClass(CELL);\n    classNames.item = api.getClass(ITEM);\n    const unsub = state.subscribe('_internal.elements.chart-timeline', el => (chartTimelineElement = el));\n    state.update('config.actions.chart-timeline', timelineActions => {\n      timelineActions.push(TimelinePointerAction);\n      return timelineActions;\n    });\n    state.update(pluginPath, data => {\n      return generateEmptyData();\n    });\n\n    return function destroy() {\n      unsub();\n    };\n  };\n}\n","/**\n * ItemMovement plugin\n *\n * @copyright Rafal Pospiech <https://neuronet.io>\n * @author    Rafal Pospiech <neuronet.io@gmail.com>\n * @package   gantt-schedule-timeline-calendar\n * @license   AGPL-3.0 (https://github.com/neuronetio/gantt-schedule-timeline-calendar/blob/master/LICENSE)\n * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar\n */\n\nimport DeepState from 'deep-state-observer';\nimport { vido } from '@neuronet.io/vido/vido';\nimport { Api } from '../api/Api';\nimport { PluginData as SelectionPluginData } from './Selection/Selection.plugin';\nimport { Item, InternalChartTime, Scroll, InternalChartDimensions } from '../types';\nimport { ITEM } from './TimelinePointer.plugin';\nimport { Dayjs } from 'dayjs';\n\nexport interface SnapArg {\n  time: InternalChartTime;\n  scroll: Scroll;\n  dimensions: InternalChartDimensions;\n  vido: vido<DeepState, Api>;\n  movement: Movement;\n}\n\nexport interface SnapStartArg extends SnapArg {\n  startTime: Dayjs;\n}\n\nexport interface SnapEndArg extends SnapArg {\n  endTime: Dayjs;\n}\n\nexport interface Options {\n  enabled?: boolean;\n  className?: string;\n  onStart?: (items: Item[]) => void;\n  onMove?: (items: Item[]) => void;\n  onEnd?: (items: Item[]) => void;\n  snapStart?: (snapStartArgs: SnapStartArg) => Dayjs;\n  snapEnd?: (snapEndArgs: SnapEndArg) => Dayjs;\n}\n\nexport interface MovementResult {\n  horizontal: number;\n  vertical: number;\n}\n\nexport interface Movement {\n  px: MovementResult;\n  time: number;\n}\n\nexport interface PluginData extends Options {\n  moving: Item[];\n  lastMoved: Item[];\n  movement: Movement;\n}\n\nfunction prepareOptions(options: Options): Options {\n  return {\n    enabled: true,\n    className: '',\n    ...options\n  };\n}\n\nconst pluginPath = 'config.plugin.ItemMovement';\n\nfunction gemerateEmptyPluginData(options: Options): PluginData {\n  return {\n    moving: [],\n    lastMoved: [],\n    movement: {\n      px: { horizontal: 0, vertical: 0 },\n      time: 0\n    },\n    onStart(items) {\n      console.log('start moving', items);\n    },\n    onMove(items) {\n      console.log('move', items);\n    },\n    onEnd(items) {\n      console.log('end move', items);\n    },\n    snapStart({ startTime, time }) {\n      return startTime.startOf(time.period);\n    },\n    snapEnd({ endTime, time }) {\n      return endTime.endOf(time.period);\n    },\n    ...options\n  };\n}\n\nclass ItemMovement {\n  private vido: vido<DeepState, Api>;\n  private api: Api;\n  private state: DeepState;\n  private onDestroy = [];\n  private selection: SelectionPluginData;\n  private lastPointerState: 'up' | 'down' | 'move' = 'up';\n  private data: PluginData;\n\n  constructor(vido: vido<DeepState, Api>) {\n    this.vido = vido;\n    this.api = vido.api;\n    this.state = vido.state;\n    this.onDestroy.push(this.state.subscribe(pluginPath, data => (this.data = data)));\n    if (!this.data.className) this.data.className = this.api.getClass('chart-timeline-items-row-item--moving');\n    this.onSelectionChange = this.onSelectionChange.bind(this);\n    this.onDestroy.push(this.state.subscribe('config.plugin.Selection', this.onSelectionChange));\n  }\n\n  destroy() {\n    this.onDestroy.forEach(unsub => unsub());\n  }\n\n  updateData() {\n    this.state.update(pluginPath, this.data);\n  }\n\n  getItemTime(currentTime: Dayjs): Dayjs {\n    return currentTime;\n  }\n\n  moveItems() {\n    for (const item of this.data.lastMoved) {\n      const startTime = this.getItemTime(item._internal.time.startDate);\n    }\n  }\n\n  updatePointerState() {\n    if (this.lastPointerState === 'up' && this.selection.pointerState === 'down') {\n      this.data.onStart(this.data.moving);\n    } else if (\n      (this.lastPointerState === 'down' || this.lastPointerState === 'move') &&\n      this.selection.pointerState === 'up'\n    ) {\n      this.data.moving = [];\n      this.data.onEnd(this.data.lastMoved);\n    } else if (this.selection.pointerState === 'move') {\n      this.data.onMove(this.data.moving);\n    }\n    this.lastPointerState = this.selection.pointerState;\n  }\n\n  onSelectionChange(data: SelectionPluginData) {\n    if (!this.data.enabled) return;\n    this.selection = data;\n    if (this.selection.events.move) {\n      this.selection.events.move.preventDefault();\n      this.selection.events.move.stopPropagation();\n    }\n    if (this.selection.events.down) {\n      this.selection.events.down.preventDefault();\n      this.selection.events.down.stopPropagation();\n    }\n    this.data.moving = [...this.selection.selected[ITEM]];\n    if (this.data.moving.length) this.data.lastMoved = [...this.data.moving];\n\n    this.updatePointerState();\n\n    this.data.movement.px.horizontal = this.selection.currentPosition.x - this.selection.initialPosition.x;\n    this.data.movement.px.vertical = this.selection.currentPosition.y - this.selection.initialPosition.y;\n\n    this.moveItems();\n    this.updateData();\n  }\n}\n\nexport function Plugin(options: Options = {}) {\n  return function initialize(vidoInstance: vido<DeepState, Api>) {\n    vidoInstance.state.update(pluginPath, gemerateEmptyPluginData(prepareOptions(options)));\n    new ItemMovement(vidoInstance);\n  };\n}\n"],"names":[],"mappings":";;;;;;EAAA;;;;;;;;;EAeO,MAAM,IAAI,GAAG,+BAA+B,CAAC;;;ECfpD;;;;;;;;;EA4DA,SAAS,cAAc,CAAC,OAAgB;MACtC,uBACE,OAAO,EAAE,IAAI,EACb,SAAS,EAAE,EAAE,IACV,OAAO,EACV;EACJ,CAAC;EAED,MAAM,UAAU,GAAG,4BAA4B,CAAC;EAEhD,SAAS,uBAAuB,CAAC,OAAgB;MAC/C,uBACE,MAAM,EAAE,EAAE,EACV,SAAS,EAAE,EAAE,EACb,QAAQ,EAAE;cACR,EAAE,EAAE,EAAE,UAAU,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE;cAClC,IAAI,EAAE,CAAC;WACR,EACD,OAAO,CAAC,KAAK;cACX,OAAO,CAAC,GAAG,CAAC,cAAc,EAAE,KAAK,CAAC,CAAC;WACpC;UACD,MAAM,CAAC,KAAK;cACV,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;WAC5B;UACD,KAAK,CAAC,KAAK;cACT,OAAO,CAAC,GAAG,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;WAChC;UACD,SAAS,CAAC,EAAE,SAAS,EAAE,IAAI,EAAE;cAC3B,OAAO,SAAS,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;WACvC;UACD,OAAO,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE;cACvB,OAAO,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;WACnC,IACE,OAAO,EACV;EACJ,CAAC;EAED,MAAM,YAAY;MAShB,YAAY,IAA0B;UAL9B,cAAS,GAAG,EAAE,CAAC;UAEf,qBAAgB,GAA2B,IAAI,CAAC;UAItD,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;UACjB,IAAI,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC;UACpB,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;UACxB,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,UAAU,EAAE,IAAI,KAAK,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;UAClF,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS;cAAE,IAAI,CAAC,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,uCAAuC,CAAC,CAAC;UAC3G,IAAI,CAAC,iBAAiB,GAAG,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;UAC3D,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,yBAAyB,EAAE,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC;OAC9F;MAED,OAAO;UACL,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,KAAK,IAAI,KAAK,EAAE,CAAC,CAAC;OAC1C;MAED,UAAU;UACR,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,UAAU,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;OAC1C;MAED,WAAW,CAAC,WAAkB;UAC5B,OAAO,WAAW,CAAC;OACpB;MAED,SAAS;UACP,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE;cACtC,MAAM,SAAS,GAAG,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;WACnE;OACF;MAED,kBAAkB;UAChB,IAAI,IAAI,CAAC,gBAAgB,KAAK,IAAI,IAAI,IAAI,CAAC,SAAS,CAAC,YAAY,KAAK,MAAM,EAAE;cAC5E,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;WACrC;eAAM,IACL,CAAC,IAAI,CAAC,gBAAgB,KAAK,MAAM,IAAI,IAAI,CAAC,gBAAgB,KAAK,MAAM;cACrE,IAAI,CAAC,SAAS,CAAC,YAAY,KAAK,IAAI,EACpC;cACA,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;cACtB,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;WACtC;eAAM,IAAI,IAAI,CAAC,SAAS,CAAC,YAAY,KAAK,MAAM,EAAE;cACjD,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;WACpC;UACD,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC;OACrD;MAED,iBAAiB,CAAC,IAAyB;UACzC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO;cAAE,OAAO;UAC/B,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;UACtB,IAAI,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,EAAE;cAC9B,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,cAAc,EAAE,CAAC;cAC5C,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC;WAC9C;UACD,IAAI,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,EAAE;cAC9B,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,cAAc,EAAE,CAAC;cAC5C,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC;WAC9C;UACD,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC;UACtD,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM;cAAE,IAAI,CAAC,IAAI,CAAC,SAAS,GAAG,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;UAEzE,IAAI,CAAC,kBAAkB,EAAE,CAAC;UAE1B,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC,eAAe,CAAC,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,eAAe,CAAC,CAAC,CAAC;UACvG,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,eAAe,CAAC,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,eAAe,CAAC,CAAC,CAAC;UAErG,IAAI,CAAC,SAAS,EAAE,CAAC;UACjB,IAAI,CAAC,UAAU,EAAE,CAAC;OACnB;GACF;WAEe,MAAM,CAAC,UAAmB,EAAE;MAC1C,OAAO,SAAS,UAAU,CAAC,YAAkC;UAC3D,YAAY,CAAC,KAAK,CAAC,MAAM,CAAC,UAAU,EAAE,uBAAuB,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;UACxF,IAAI,YAAY,CAAC,YAAY,CAAC,CAAC;OAChC,CAAC;EACJ;;;;;;;;;;;;"}