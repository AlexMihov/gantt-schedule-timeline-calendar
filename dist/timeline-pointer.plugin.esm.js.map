{"version":3,"file":"timeline-pointer.plugin.esm.js","sources":["../src/plugins/timeline-pointer.plugin.ts"],"sourcesContent":["/**\n * TimelinePointer plugin\n *\n * @copyright Rafal Pospiech <https://neuronet.io>\n * @author    Rafal Pospiech <neuronet.io@gmail.com>\n * @package   gantt-schedule-timeline-calendar\n * @license   AGPL-3.0 (https://github.com/neuronetio/gantt-schedule-timeline-calendar/blob/master/LICENSE)\n * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar\n */\n\nimport DeepState from 'deep-state-observer';\nimport { Api } from '../api/api';\nimport { Vido } from '../gstc';\n\nexport const CELL = 'chart-timeline-grid-row-cell';\nexport type CELL_TYPE = 'chart-timeline-grid-row-cell';\nexport const ITEM = 'chart-timeline-items-row-item';\nexport type ITEM_TYPE = 'chart-timeline-items-row-item';\n\nexport interface PointerEvents {\n  down: PointerEvent | null;\n  move: PointerEvent | null;\n  up: PointerEvent | null;\n}\n\nexport interface Point {\n  x: number;\n  y: number;\n}\n\nexport type PointerState = 'up' | 'down' | 'move';\n\nexport interface PluginData {\n  enabled: boolean;\n  isMoving: boolean;\n  pointerState: PointerState;\n  currentTarget: HTMLElement | null;\n  realTarget: HTMLElement | null;\n  targetType: ITEM_TYPE | CELL_TYPE | '';\n  targetData: any | null;\n  events: PointerEvents;\n  initialPosition: Point;\n  currentPosition: Point;\n}\n\nexport function Plugin(options = { enabled: true }) {\n  let vido: Vido, api: Api, state: DeepState;\n  const pluginPath = 'config.plugin.TimelinePointer';\n\n  const classNames = {\n    cell: '',\n    item: '',\n  };\n\n  function generateEmptyData(): PluginData {\n    return {\n      enabled: options.enabled,\n      isMoving: false,\n      pointerState: 'up',\n      currentTarget: null,\n      realTarget: null,\n      targetType: '',\n      targetData: null,\n      initialPosition: { x: 0, y: 0 },\n      currentPosition: { x: 0, y: 0 },\n      events: {\n        down: null,\n        move: null,\n        up: null,\n      },\n    };\n  }\n\n  let chartTimelineElement: HTMLElement;\n\n  class TimelinePointerAction {\n    private data: PluginData;\n    private unsub = [];\n\n    constructor(element) {\n      this.pointerDown = this.pointerDown.bind(this);\n      this.pointerMove = this.pointerMove.bind(this);\n      this.pointerUp = this.pointerUp.bind(this);\n      this.data = generateEmptyData();\n      element.addEventListener('pointerdown', this.pointerDown);\n      document.addEventListener('pointerup', this.pointerUp);\n      document.addEventListener('pointermove', this.pointerMove);\n      this.unsub.push(state.subscribe(pluginPath, (value) => (this.data = value)));\n    }\n\n    public destroy(element) {\n      element.removeEventListener('pointerdown', this.pointerDown);\n      document.removeEventListener('pointerup', this.pointerUp);\n      document.removeEventListener('pointermove', this.pointerMove);\n    }\n\n    private updateData() {\n      state.update(pluginPath, () => ({ ...this.data }));\n    }\n\n    private getRealTarget(ev: PointerEvent) {\n      let realTarget: HTMLElement = (ev.target as HTMLElement).closest('.' + classNames.item) as HTMLElement;\n      if (realTarget) {\n        return realTarget;\n      }\n      realTarget = (ev.target as HTMLElement).closest('.' + classNames.cell) as HTMLElement;\n      if (realTarget) {\n        return realTarget;\n      }\n      return null;\n    }\n\n    getRealPosition(ev: PointerEvent): Point {\n      const pos = { x: 0, y: 0 };\n      if (chartTimelineElement) {\n        const bounding = chartTimelineElement.getBoundingClientRect();\n        pos.x = ev.x - bounding.x;\n        pos.y = ev.y - bounding.y;\n      }\n      return pos;\n    }\n\n    private pointerDown(ev: PointerEvent) {\n      if (!this.data.enabled) return;\n      this.data.pointerState = 'down';\n      this.data.currentTarget = ev.target as HTMLElement;\n      this.data.realTarget = this.getRealTarget(ev);\n      if (this.data.realTarget) {\n        if (this.data.realTarget.classList.contains(classNames.item)) {\n          this.data.targetType = ITEM;\n          // @ts-ignore\n          this.data.targetData = this.data.realTarget.vido.item;\n        } else if (this.data.realTarget.classList.contains(classNames.cell)) {\n          this.data.targetType = CELL;\n          // @ts-ignore\n          this.data.targetData = this.data.realTarget.vido;\n        } else {\n          this.data.targetType = '';\n        }\n      } else {\n        this.data.targetType = '';\n        this.data.targetData = null;\n      }\n      this.data.isMoving = !!this.data.realTarget;\n      this.data.events.down = ev;\n      this.data.events.move = ev;\n      const realPosition = this.getRealPosition(ev);\n      this.data.initialPosition = realPosition;\n      this.data.currentPosition = realPosition;\n      this.updateData();\n    }\n\n    private pointerUp(ev: PointerEvent) {\n      if (!this.data.enabled) return;\n      this.data.pointerState = 'up';\n      this.data.isMoving = false;\n      this.data.events.up = ev;\n      this.data.currentPosition = this.getRealPosition(ev);\n      this.updateData();\n    }\n\n    private pointerMove(ev: PointerEvent) {\n      if (!this.data.enabled || !this.data.isMoving) return;\n      this.data.pointerState = 'move';\n      this.data.events.move = ev;\n      this.data.currentPosition = this.getRealPosition(ev);\n      this.updateData();\n    }\n  }\n\n  return function initialize(vidoInstance: Vido) {\n    vido = vidoInstance;\n    api = vido.api;\n    state = vido.state;\n    classNames.cell = api.getClass(CELL);\n    classNames.item = api.getClass(ITEM);\n    const unsub = state.subscribe('$data.elements.chart-timeline', (el) => (chartTimelineElement = el));\n    state.update('config.actions.chart-timeline', (timelineActions) => {\n      timelineActions.push(TimelinePointerAction);\n      return timelineActions;\n    });\n    state.update(pluginPath, (data) => {\n      return generateEmptyData();\n    });\n\n    return function destroy() {\n      unsub();\n    };\n  };\n}\n"],"names":[],"mappings":"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"}