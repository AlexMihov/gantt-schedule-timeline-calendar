{"version":3,"file":"item-movement.plugin.esm.js","sources":["../src/plugins/timeline-pointer.plugin.ts","../src/plugins/item-movement.plugin.ts"],"sourcesContent":["/**\n * TimelinePointer plugin\n *\n * @copyright Rafal Pospiech <https://neuronet.io>\n * @author    Rafal Pospiech <neuronet.io@gmail.com>\n * @package   gantt-schedule-timeline-calendar\n * @license   AGPL-3.0 (https://github.com/neuronetio/gantt-schedule-timeline-calendar/blob/master/LICENSE)\n * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar\n */\n\nimport DeepState from 'deep-state-observer';\nimport { Api } from '../api/api';\nimport { Vido } from '../gstc';\n\nexport const CELL = 'chart-timeline-grid-row-cell';\nexport type CELL_TYPE = 'chart-timeline-grid-row-cell';\nexport const ITEM = 'chart-timeline-items-row-item';\nexport type ITEM_TYPE = 'chart-timeline-items-row-item';\n\nexport interface PointerEvents {\n  down: PointerEvent | null;\n  move: PointerEvent | null;\n  up: PointerEvent | null;\n}\n\nexport interface Point {\n  x: number;\n  y: number;\n}\n\nexport type PointerState = 'up' | 'down' | 'move';\n\nexport interface PluginData {\n  enabled: boolean;\n  isMoving: boolean;\n  pointerState: PointerState;\n  currentTarget: HTMLElement | null;\n  realTarget: HTMLElement | null;\n  targetType: ITEM_TYPE | CELL_TYPE | '';\n  targetData: any | null;\n  events: PointerEvents;\n  initialPosition: Point;\n  currentPosition: Point;\n}\n\nexport function Plugin(options = { enabled: true }) {\n  let vido: Vido, api: Api, state: DeepState;\n  const pluginPath = 'config.plugin.TimelinePointer';\n\n  const classNames = {\n    cell: '',\n    item: '',\n  };\n\n  function generateEmptyData(): PluginData {\n    return {\n      enabled: options.enabled,\n      isMoving: false,\n      pointerState: 'up',\n      currentTarget: null,\n      realTarget: null,\n      targetType: '',\n      targetData: null,\n      initialPosition: { x: 0, y: 0 },\n      currentPosition: { x: 0, y: 0 },\n      events: {\n        down: null,\n        move: null,\n        up: null,\n      },\n    };\n  }\n\n  let chartTimelineElement: HTMLElement;\n\n  class TimelinePointerAction {\n    private data: PluginData;\n    private unsub = [];\n\n    constructor(element) {\n      this.pointerDown = this.pointerDown.bind(this);\n      this.pointerMove = this.pointerMove.bind(this);\n      this.pointerUp = this.pointerUp.bind(this);\n      this.data = generateEmptyData();\n      element.addEventListener('pointerdown', this.pointerDown);\n      document.addEventListener('pointerup', this.pointerUp);\n      document.addEventListener('pointermove', this.pointerMove);\n      this.unsub.push(state.subscribe(pluginPath, (value) => (this.data = value)));\n    }\n\n    public destroy(element) {\n      element.removeEventListener('pointerdown', this.pointerDown);\n      document.removeEventListener('pointerup', this.pointerUp);\n      document.removeEventListener('pointermove', this.pointerMove);\n    }\n\n    private updateData() {\n      state.update(pluginPath, () => ({ ...this.data }));\n    }\n\n    private getRealTarget(ev: PointerEvent) {\n      let realTarget: HTMLElement = (ev.target as HTMLElement).closest('.' + classNames.item) as HTMLElement;\n      if (realTarget) {\n        return realTarget;\n      }\n      realTarget = (ev.target as HTMLElement).closest('.' + classNames.cell) as HTMLElement;\n      if (realTarget) {\n        return realTarget;\n      }\n      return null;\n    }\n\n    getRealPosition(ev: PointerEvent): Point {\n      const pos = { x: 0, y: 0 };\n      if (chartTimelineElement) {\n        const bounding = chartTimelineElement.getBoundingClientRect();\n        pos.x = ev.x - bounding.x;\n        pos.y = ev.y - bounding.y;\n      }\n      return pos;\n    }\n\n    private pointerDown(ev: PointerEvent) {\n      if (!this.data.enabled) return;\n      this.data.pointerState = 'down';\n      this.data.currentTarget = ev.target as HTMLElement;\n      this.data.realTarget = this.getRealTarget(ev);\n      if (this.data.realTarget) {\n        if (this.data.realTarget.classList.contains(classNames.item)) {\n          this.data.targetType = ITEM;\n          // @ts-ignore\n          this.data.targetData = this.data.realTarget.vido.item;\n        } else if (this.data.realTarget.classList.contains(classNames.cell)) {\n          this.data.targetType = CELL;\n          // @ts-ignore\n          this.data.targetData = this.data.realTarget.vido;\n        } else {\n          this.data.targetType = '';\n        }\n      } else {\n        this.data.targetType = '';\n        this.data.targetData = null;\n      }\n      this.data.isMoving = !!this.data.realTarget;\n      this.data.events.down = ev;\n      this.data.events.move = ev;\n      const realPosition = this.getRealPosition(ev);\n      this.data.initialPosition = realPosition;\n      this.data.currentPosition = realPosition;\n      this.updateData();\n    }\n\n    private pointerUp(ev: PointerEvent) {\n      if (!this.data.enabled) return;\n      this.data.pointerState = 'up';\n      this.data.isMoving = false;\n      this.data.events.up = ev;\n      this.data.currentPosition = this.getRealPosition(ev);\n      this.updateData();\n    }\n\n    private pointerMove(ev: PointerEvent) {\n      if (!this.data.enabled || !this.data.isMoving) return;\n      this.data.pointerState = 'move';\n      this.data.events.move = ev;\n      this.data.currentPosition = this.getRealPosition(ev);\n      this.updateData();\n    }\n  }\n\n  return function initialize(vidoInstance: Vido) {\n    vido = vidoInstance;\n    api = vido.api;\n    state = vido.state;\n    classNames.cell = api.getClass(CELL);\n    classNames.item = api.getClass(ITEM);\n    const unsub = state.subscribe('$data.elements.chart-timeline', (el) => (chartTimelineElement = el));\n    state.update('config.actions.chart-timeline', (timelineActions) => {\n      timelineActions.push(TimelinePointerAction);\n      return timelineActions;\n    });\n    state.update(pluginPath, (data) => {\n      return generateEmptyData();\n    });\n\n    return function destroy() {\n      unsub();\n    };\n  };\n}\n","/**\n * ItemMovement plugin\n *\n * @copyright Rafal Pospiech <https://neuronet.io>\n * @author    Rafal Pospiech <neuronet.io@gmail.com>\n * @package   gantt-schedule-timeline-calendar\n * @license   AGPL-3.0 (https://github.com/neuronetio/gantt-schedule-timeline-calendar/blob/master/LICENSE)\n * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar\n */\n\nimport { PluginData as SelectionPluginData } from './selection.plugin';\nimport { Item, DataChartTime, Scroll, DataChartDimensions, ItemTime, Vido, ItemDataTime, Row } from '../gstc';\nimport { ITEM, Point } from './timeline-pointer.plugin';\nimport { Dayjs } from 'dayjs';\nimport { Api } from '../api/api';\nimport DeepState from 'deep-state-observer';\n\nexport interface SnapArg {\n  item: Item;\n  time: DataChartTime;\n  vido: Vido;\n  movement: Movement;\n}\n\nexport interface SnapStartArg extends SnapArg {\n  startTime: Dayjs;\n}\n\nexport interface SnapEndArg extends SnapArg {\n  endTime: Dayjs;\n}\n\nexport interface OnArg {\n  items: Item[];\n  vido: Vido;\n  time: DataChartTime;\n  movement: Movement;\n}\n\nexport interface SnapToTime {\n  start?: (snapStartArgs: SnapStartArg) => Dayjs;\n  end?: (snapEndArgs: SnapEndArg) => Dayjs;\n}\n\nexport interface Options {\n  enabled?: boolean;\n  className?: string;\n  bodyClass?: string;\n  bodyClassMoving?: string;\n  onStart?: (onArg: OnArg) => boolean;\n  onMove?: (onArg: OnArg) => boolean;\n  onEnd?: (onArg: OnArg) => boolean;\n  onRowChange?: (item: Item, newRow: Row) => boolean;\n  snapToTime?: SnapToTime;\n}\n\nexport interface MovementResult {\n  horizontal: number;\n  vertical: number;\n}\n\nexport interface Movement {\n  px: MovementResult;\n  time: number;\n}\n\nexport interface PluginData extends Options {\n  moving: Item[];\n  initialItems: Item[];\n  movement: Movement;\n  lastPosition: Point;\n  pointerState: 'up' | 'down' | 'move';\n  state: State;\n  pointerMoved: boolean;\n}\n\nexport interface MovingTimes {\n  startTime: Dayjs;\n  endTime: Dayjs;\n}\n\nexport type State = '' | 'start' | 'end' | 'move';\n\nexport interface Cumulation {\n  start: number;\n  end: number;\n}\n\nexport interface Cumulations {\n  [key: string]: Cumulation;\n}\n\nfunction prepareOptions(options: Options): Options {\n  return {\n    enabled: true,\n    className: '',\n    bodyClass: 'gstc-item-movement',\n    bodyClassMoving: 'gstc-items-moving',\n    ...options,\n  };\n}\n\nconst pluginPath = 'config.plugin.ItemMovement';\n\nfunction gemerateEmptyPluginData(options: Options): PluginData {\n  return {\n    moving: [],\n    initialItems: [],\n    pointerState: 'up',\n    pointerMoved: false,\n    state: '',\n    lastPosition: { x: 0, y: 0 },\n    movement: {\n      px: { horizontal: 0, vertical: 0 },\n      time: 0,\n    },\n    onStart() {\n      return true;\n    },\n    onMove() {\n      return true;\n    },\n    onEnd() {\n      return true;\n    },\n    onRowChange() {\n      return true;\n    },\n    snapToTime: {\n      start({ startTime, time }) {\n        return startTime.startOf(time.period);\n      },\n      end({ endTime, time }) {\n        return endTime.endOf(time.period);\n      },\n    },\n    ...options,\n  };\n}\n\nclass ItemMovement {\n  private vido: Vido;\n  private api: Api;\n  private state: DeepState;\n  private onDestroy = [];\n  private selection: SelectionPluginData;\n  private data: PluginData;\n  private cumulations: Cumulations = {};\n  private merge: (target: object, source: object) => object;\n\n  constructor(vido: Vido) {\n    this.vido = vido;\n    this.api = vido.api;\n    this.state = vido.state;\n    this.merge = this.state.get('config.merge');\n    this.onDestroy.push(\n      this.state.subscribe(pluginPath, (data) => {\n        this.data = data;\n        if (!data.enabled) {\n          document.body.classList.remove(this.data.bodyClass);\n        } else {\n          document.body.classList.add(this.data.bodyClass);\n        }\n      })\n    );\n    if (!this.data.className) this.data.className = this.api.getClass('chart-timeline-items-row-item--moving');\n    this.onSelectionChange = this.onSelectionChange.bind(this);\n    this.onDestroy.push(this.state.subscribe('config.plugin.Selection', this.onSelectionChange));\n  }\n\n  public destroy() {\n    this.onDestroy.forEach((unsub) => unsub());\n  }\n\n  private updateData() {\n    this.state.update(pluginPath, this.data);\n  }\n\n  private clearCumulationsForItems() {\n    this.cumulations = {};\n  }\n\n  private setStartCumulationForItem(item: Item, cumulation: number) {\n    if (!this.cumulations[item.id]) {\n      this.cumulations[item.id] = { start: 0, end: 0 };\n    }\n    this.cumulations[item.id].start = cumulation;\n  }\n\n  private getStartCumulationForItem(item: Item): number {\n    return this.cumulations[item.id]?.start || 0;\n  }\n\n  private getItemMovingTimes(item: Item, time: DataChartTime): MovingTimes {\n    const horizontal = this.data.movement.px.horizontal;\n    const positionLeft = this.api.time.getViewOffsetPxFromDates(item.$data.time.startDate, false, time);\n    const x = positionLeft + horizontal + this.getStartCumulationForItem(item);\n    const leftGlobal = this.api.time.getTimeFromViewOffsetPx(x, time);\n    const startTime = this.data.snapToTime.start({\n      startTime: this.api.time.date(leftGlobal),\n      item,\n      time,\n      movement: this.data.movement,\n      vido: this.vido,\n    });\n    const snapStartPxDiff = this.api.time.getDatesDiffPx(startTime, this.api.time.date(leftGlobal), time, true);\n    this.setStartCumulationForItem(item, snapStartPxDiff);\n    const startEndTimeDiff = item.$data.time.endDate.diff(item.$data.time.startDate, 'millisecond');\n    // diff could be too much if we are in the middle of european summer time (daylight-saving time)\n    const rightGlobal = startTime.add(startEndTimeDiff, 'millisecond').valueOf();\n    const rightGlobalDate = this.api.time.date(rightGlobal);\n    /* // summer time / daylight saving time bug\n    const leftFmt = rightGlobalDate.format('YYYY-MM-DD HH:mm:ss');\n    const rightFmt = rightGlobalDate.endOf(time.period).format('YYYY-MM-DD HH:mm:ss');\n    if (leftFmt !== rightFmt) {\n      console.log('no match', leftFmt, rightFmt);\n    }*/\n    const endTime = this.data.snapToTime.end({\n      endTime: rightGlobalDate,\n      item,\n      time,\n      movement: this.data.movement,\n      vido: this.vido,\n    });\n    return { startTime, endTime };\n  }\n\n  private moveItemVertically(item: Item): Item {\n    return item;\n  }\n\n  private moveItems() {\n    const time: DataChartTime = this.state.get('$data.chart.time');\n    let multi = this.state.multi();\n    for (let item of this.data.moving) {\n      const newItemTimes = this.getItemMovingTimes(item, time);\n      item = this.moveItemVertically(item);\n      multi = multi\n        .update(`config.chart.items.${item.id}.time`, (itemTime: ItemTime) => {\n          itemTime.start = newItemTimes.startTime.valueOf();\n          itemTime.end = newItemTimes.endTime.valueOf();\n          return itemTime;\n        })\n        .update(`config.chart.items.${item.id}.$data.time`, (dataTime: ItemDataTime) => {\n          dataTime.startDate = newItemTimes.startTime;\n          dataTime.endDate = newItemTimes.endTime;\n          return dataTime;\n        });\n    }\n    multi.done();\n  }\n\n  private clearSelection() {\n    this.data.moving = [];\n    this.data.initialItems = [];\n    this.data.movement.px.horizontal = 0;\n    this.data.movement.px.vertical = 0;\n    this.data.movement.time = 0;\n    this.data.pointerState = 'up';\n    this.data.pointerMoved = false;\n  }\n\n  private onStart() {\n    this.clearCumulationsForItems();\n    document.body.classList.add(this.data.bodyClassMoving);\n    this.data.lastPosition = { ...this.selection.currentPosition };\n  }\n\n  private onEnd() {\n    document.body.classList.remove(this.data.bodyClassMoving);\n  }\n\n  private restoreInitialItems() {\n    let multi = this.state.multi();\n    for (const item of this.data.initialItems) {\n      multi = multi.update(`config.chart.items.${item.id}`, item);\n    }\n    multi.done();\n    this.clearSelection();\n    this.updateData();\n  }\n\n  private canMove(state: State, onArg: OnArg): boolean {\n    switch (state) {\n      case 'start':\n        return this.data.onStart(onArg);\n      case 'move':\n        return this.data.onMove(onArg);\n      case 'end':\n        return this.data.onEnd(onArg);\n    }\n    return true;\n  }\n\n  private onSelectionChange(data: SelectionPluginData) {\n    if (!this.data.enabled) return;\n    this.selection = data;\n    if (this.selection.targetType !== ITEM) {\n      return this.clearSelection();\n    }\n    if (this.selection.events.move) {\n      this.selection.events.move.preventDefault();\n      this.selection.events.move.stopPropagation();\n    }\n    if (this.selection.events.down) {\n      this.selection.events.down.preventDefault();\n      this.selection.events.down.stopPropagation();\n    }\n\n    if (this.data.pointerState === 'up' && this.selection.pointerState === 'down') {\n      this.data.state = 'start';\n    } else if (\n      (this.data.pointerState === 'down' || this.data.pointerState === 'move') &&\n      this.selection.pointerState === 'up'\n    ) {\n      this.data.state = 'end';\n    } else if (this.data.pointerState === 'move' && this.selection.pointerState === 'move') {\n      this.data.state = 'move';\n    } else if (\n      this.data.pointerState === 'up' &&\n      (this.selection.pointerState === 'move' || this.selection.pointerState === 'up')\n    ) {\n      // do nothing because movement was rejected\n      return;\n    }\n\n    this.data.pointerState = this.selection.pointerState;\n    this.data.moving = [...this.selection.selected[ITEM]];\n    if (this.data.state === 'start') {\n      this.data.initialItems = this.data.moving.map((item) => this.merge({}, item) as Item);\n    }\n\n    switch (this.data.state) {\n      case 'start':\n        this.onStart();\n        break;\n      case 'end':\n        this.onEnd();\n        break;\n    }\n\n    this.data.movement.px.horizontal = this.selection.currentPosition.x - this.data.lastPosition.x;\n    this.data.movement.px.vertical = this.selection.currentPosition.y - this.data.lastPosition.y;\n    this.data.lastPosition.x = this.selection.currentPosition.x;\n    this.data.lastPosition.y = this.selection.currentPosition.y;\n\n    const onArg: OnArg = {\n      items: this.data.moving,\n      vido: this.vido,\n      movement: this.data.movement,\n      time: this.state.get('$data.chart.time'),\n    };\n    if (this.canMove(this.data.state, onArg)) {\n      this.moveItems();\n    } else {\n      this.data.pointerState = 'up';\n      if (this.data.state === 'end') {\n        this.restoreInitialItems();\n      }\n    }\n    this.updateData();\n  }\n}\n\nexport function Plugin(options: Options = {}) {\n  return function initialize(vidoInstance: Vido) {\n    vidoInstance.state.update(pluginPath, gemerateEmptyPluginData(prepareOptions(options)));\n    new ItemMovement(vidoInstance);\n  };\n}\n"],"names":[],"mappings":"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"}