const t="chart-timeline-items-row-item";const e="config.plugin.ItemMovement";class i{constructor(t){this.onDestroy=[],this.cumulations={},this.relativeVerticalPosition={},this.vido=t,this.api=t.api,this.state=t.state,this.merge=this.state.get("config.merge"),this.onDestroy.push(this.state.subscribe(e,t=>{this.data=t,t.enabled?document.body.classList.add(this.data.bodyClass):document.body.classList.remove(this.data.bodyClass)})),this.data.className||(this.data.className=this.api.getClass("chart-timeline-items-row-item--moving")),this.onSelectionChange=this.onSelectionChange.bind(this),this.onDestroy.push(this.state.subscribe("config.plugin.Selection",this.onSelectionChange))}destroy(){this.onDestroy.forEach(t=>t())}updateData(){this.state.update(e,this.data)}clearCumulationsForItems(){this.cumulations={}}setStartCumulationForItem(t,e){this.cumulations[t.id]||(this.cumulations[t.id]={start:0,end:0}),this.cumulations[t.id].start=e}getStartCumulationForItem(t){var e;return(null===(e=this.cumulations[t.id])||void 0===e?void 0:e.start)||0}getItemMovingTimes(t,e){const i=this.data.movement.px.horizontal,a=this.api.time.getViewOffsetPxFromDates(t.$data.time.startDate,!1,e)+i+this.getStartCumulationForItem(t),s=this.api.time.getTimeFromViewOffsetPx(a,e),o=this.data.snapToTime.start({startTime:this.api.time.date(s),item:t,time:e,movement:this.data.movement,vido:this.vido}),n=this.api.time.getDatesDiffPx(o,this.api.time.date(s),e,!0);this.setStartCumulationForItem(t,n);const d=t.$data.time.endDate.diff(t.$data.time.startDate,"millisecond"),m=o.add(d,"millisecond").valueOf(),h=this.api.time.date(m);return{startTime:o,endTime:this.data.snapToTime.end({endTime:h,item:t,time:e,movement:this.data.movement,vido:this.vido})}}findRowAtViewPosition(t,e){const i=this.state.get("$data.list.visibleRows");for(const e of i){const i=e.$data.position.viewTop+e.$data.outerHeight;if(e.$data.position.viewTop<=t&&i>=t)return e}return e}getItemViewTop(t){return this.state.get("config.list.rows")[t.rowId].$data.position.viewTop+t.$data.position.actualTop}saveItemsRelativeVerticalPosition(){for(const t of this.data.moving){const e=this.data.position.y-this.getItemViewTop(t);this.setItemRelativeVerticalPosition(t,e)}}setItemRelativeVerticalPosition(t,e){this.relativeVerticalPosition[t.id]=e}getItemRelativeVerticalPosition(t){return this.relativeVerticalPosition[t.id]}moveItemVertically(t,e){const i=this.state.get("config.list.rows")[t.rowId],a=this.getItemRelativeVerticalPosition(t),s=this.data.position.y+a,o=this.findRowAtViewPosition(s,i);return o.id!==t.rowId&&this.data.onRowChange(t,o)&&(e=e.update(`config.chart.items.${t.id}.rowId`,o.id)),e}moveItems(){const t=this.state.get("$data.chart.time");let e=this.state.multi();const i=this.data.moving.map(t=>this.merge({},t));this.data.debug&&console.log("moveItems",i);for(let a of i){const i=this.getItemMovingTimes(a,t);e=this.moveItemVertically(a,e),i.startTime.valueOf()===a.time.start&&i.endTime.valueOf()===a.time.end||(e=e.update(`config.chart.items.${a.id}.time`,t=>(t.start=i.startTime.valueOf(),t.end=i.endTime.valueOf(),t)).update(`config.chart.items.${a.id}.$data.time`,t=>(t.startDate=i.startTime,t.endDate=i.endTime,t)))}e.done()}clearSelection(){this.data.moving=[],this.data.initialItems=[],this.data.movement.px.horizontal=0,this.data.movement.px.vertical=0,this.data.movement.time=0,this.data.pointerState="up",this.data.pointerMoved=!1}onStart(){this.clearCumulationsForItems(),document.body.classList.add(this.data.bodyClassMoving),this.data.position=Object.assign({},this.selection.currentPosition),this.data.lastMovement.time=this.data.moving[0].time.start,this.saveItemsRelativeVerticalPosition()}onEnd(){document.body.classList.remove(this.data.bodyClassMoving)}restoreInitialItems(){let t=this.state.multi();this.data.debug&&console.log("restoreInitialItems",[...this.data.initialItems]);for(const e of this.data.initialItems)t=t.update(`config.chart.items.${e.id}`,e);t.done(),this.clearSelection(),this.updateData()}canMove(t,e){switch(this.data.debug&&console.log("canMove",t,e),t){case"start":return this.data.debug&&console.log("canMove start",t,e,this.data.onStart),this.data.onStart(e);case"move":return this.data.debug&&console.log("canMove move",t,e,this.data.onMove),this.data.onMove(e);case"end":return this.data.debug&&console.log("canMove end",t,e,this.data.onEnd),this.data.onEnd(e)}return!0}onSelectionChange(e){if(!this.data.enabled)return;if(this.selection=e,this.selection.targetType!==t)return this.clearSelection();if(this.selection.events.move&&(this.selection.events.move.preventDefault(),this.selection.events.move.stopPropagation()),this.selection.events.down&&(this.selection.events.down.preventDefault(),this.selection.events.down.stopPropagation()),"up"===this.data.pointerState&&"down"===this.selection.pointerState)this.data.state="start";else if("down"!==this.data.pointerState&&"move"!==this.data.pointerState||"up"!==this.selection.pointerState){if("move"===this.data.pointerState&&"move"===this.selection.pointerState)this.data.state="move";else if("up"===this.data.pointerState&&("move"===this.selection.pointerState||"up"===this.selection.pointerState))return}else this.data.state="end";switch(this.data.pointerState=this.selection.pointerState,this.data.moving=[...this.selection.selected[t]],"start"===this.data.state&&(this.data.initialItems=this.data.moving.map(t=>this.merge({},t))),this.data.debug&&console.log("state",this.data.pointerState),this.data.state){case"start":this.onStart();break;case"end":this.onEnd()}if(this.data.lastMovement.x=this.data.movement.px.horizontal,this.data.lastMovement.y=this.data.movement.px.vertical,this.data.movement.px.horizontal=this.selection.currentPosition.x-this.data.position.x,this.data.movement.px.vertical=this.selection.currentPosition.y-this.data.position.y,this.data.movement.time=this.data.moving[0].time.start-this.data.lastMovement.time,this.data.position.x=this.selection.currentPosition.x,this.data.position.y=this.selection.currentPosition.y,this.data.lastMovement.time=this.data.moving[0].time.start,"move"===this.data.state&&this.data.lastMovement.x===this.data.movement.px.horizontal&&this.data.lastMovement.y===this.data.movement.px.vertical)return this.updateData();const i={items:this.data.moving.map(t=>this.merge({},t)),vido:this.vido,movement:Object.assign(Object.assign({},this.data.movement),{px:Object.assign({},this.data.movement.px)}),time:this.state.get("$data.chart.time")};"end"===this.data.state&&(i.movement={time:this.data.moving[0].time.start-this.data.initialItems[0].time.start,px:{horizontal:this.data.moving[0].$data.position.left-this.data.initialItems[0].$data.position.left,vertical:this.data.moving[0].$data.position.viewTop-this.data.initialItems[0].$data.position.viewTop}}),this.canMove(this.data.state,i)?this.moveItems():(this.data.pointerState="up","end"===this.data.state&&this.restoreInitialItems()),this.updateData()}}function a(t={}){return function(a){a.state.update(e,function(t){const e=Object.assign({debug:!1,moving:[],initialItems:[],pointerState:"up",pointerMoved:!1,state:"",position:{x:0,y:0},movement:{px:{horizontal:0,vertical:0},time:0},lastMovement:{x:0,y:0,time:0},onStart:()=>!0,onMove:()=>!0,onEnd:()=>!0,onRowChange:()=>!0,snapToTime:{start:({startTime:t,time:e})=>t.startOf(e.period),end:({endTime:t,time:e})=>t.endOf(e.period)}},t);return t.snapToTime&&(e.snapToTime=Object.assign(Object.assign({},e.snapToTime),t.snapToTime)),e}(function(t){return Object.assign({enabled:!0,className:"",bodyClass:"gstc-item-movement",bodyClassMoving:"gstc-items-moving"},t)}(t))),new i(a)}}export{a as Plugin};
