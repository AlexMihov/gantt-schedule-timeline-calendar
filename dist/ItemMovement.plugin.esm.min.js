const t="undefined"!=typeof PointerEvent;export default function(e={}){const i={moveable:!0,resizable:!0,resizerContent:"",collisionDetection:!0,outOfBorders:!1,snapStart:(t,e)=>t+e,snapEnd:(t,e)=>t+e,ghostNode:!0,wait:0};e=Object.assign(Object.assign({},i),e);const n={};function o(i,o){if(!e.moveable&&!e.resizable)return;const r=o.state,s=o.api;function a(t){let i=e.resizable&&(!t.item.hasOwnProperty("resizable")||!0===t.item.resizable);return t.row.hasOwnProperty("resizable")&&i&&(i=t.row.resizable),i}function m(t){const e=t.item.id;return void 0===n[e]&&(n[e]={moving:!1,resizing:!1,waiting:!1}),n[e]}function l(t,e){r.update("config.plugin.ItemMovement.item",Object.assign({id:t},e)),r.update("config.plugin.ItemMovement.movement",t=>(t||(t={moving:!1,waiting:!1,resizing:!1}),t.moving=e.moving,t.waiting=e.waiting,t.resizing=e.resizing,t))}function d(t,n){if(e.ghostNode){const e=m(t),o=n.clientX-e.ganttLeft;e.ghost.style.left=o+"px",e.ghost.style.top=n.clientY-e.ganttTop-e.itemTop+parseInt(getComputedStyle(i)["margin-top"])+"px",l(t.item.id,e)}}function c(t){e.ghostNode&&void 0!==n[t]&&void 0!==n[t].ghost&&(r.get("_internal.elements.chart-timeline").removeChild(n[t].ghost),delete n[t].ghost,l(o.item.id,n[t]))}function u(t){let i=e.snapStart;return"function"==typeof t.item.snapStart&&(i=t.item.snapStart),i}function g(t){let i=e.snapEnd;return"function"==typeof t.item.snapEnd&&(i=t.item.snapEnd),i}const v=`<div class="${s.getClass("chart-timeline-items-row-item-resizer")}">${e.resizerContent}</div>`;i.insertAdjacentHTML("beforeend",v);const f=i.querySelector(".gantt-schedule-timeline-calendar__chart-timeline-items-row-item-resizer");function p(t){const n=s.normalizePointerEvent(t);if(("pointerdown"===t.type||"mousedown"===t.type)&&0!==t.button)return;const a=m(o);a.waiting=!0,l(o.item.id,a),setTimeout(()=>{if(t.stopPropagation(),t.preventDefault(),!a.waiting)return;a.moving=!0;const s=r.get(`config.chart.items.${o.item.id}`),d=r.get("_internal.chart.time.leftGlobal"),c=r.get("_internal.chart.time.timePerPixel"),u=r.get("_internal.elements.chart-timeline").getBoundingClientRect();a.ganttTop=u.top,a.ganttLeft=u.left,a.itemX=Math.round((s.time.start-d)/c),l(o.item.id,a),function(t,n,o,s){const a=m(t);if(!e.ghostNode||void 0!==a.ghost)return;const d=i.cloneNode(!0),c=getComputedStyle(i);d.style.position="absolute",d.style.left=n.clientX-o+"px";const u=n.clientY-s-i.offsetTop+parseInt(c["margin-top"]);a.itemTop=u,d.style.top=n.clientY-s-u+"px",d.style.width=c.width,d.style["box-shadow"]="10px 10px 6px #00000020";const g=i.clientHeight+"px";d.style.height=g,d.style["line-height"]=i.clientHeight-18+"px",d.style.opacity="0.6",d.style.transform="scale(1.05, 1.05)",r.get("_internal.elements.chart-timeline").appendChild(d),a.ghost=d,l(t.item.id,a)}(o,n,u.left,u.top)},e.wait)}function h(t){if(t.stopPropagation(),t.preventDefault(),("pointerdown"===t.type||"mousedown"===t.type)&&0!==t.button)return;s.normalizePointerEvent(t);const e=m(o);e.resizing=!0;const i=r.get(`config.chart.items.${o.item.id}`),n=r.get("_internal.chart.time.leftGlobal"),a=r.get("_internal.chart.time.timePerPixel"),d=r.get("_internal.elements.chart-timeline").getBoundingClientRect();e.ganttTop=d.top,e.ganttLeft=d.left,e.itemX=(i.time.end-n)/a,l(o.item.id,e)}function w(t,i,n,o){if(!e.collisionDetection)return!1;const a=r.get("_internal.chart.time");if(e.outOfBorders&&(n<a.from||o>a.to))return!0;let m=s.time.date(o).diff(n,"milliseconds");if(-1===Math.sign(m)&&(m=-m),m<=1)return!0;const l=r.get("config.list.rows."+t);for(const t of l._internal.items)if(t.id!==i){if(n>=t.time.start&&n<=t.time.end)return!0;if(o>=t.time.start&&o<=t.time.end)return!0;if(n<=t.time.start&&o>=t.time.end)return!0}return!1}function y(t){const i=m(o),n=s.normalizePointerEvent(t);let l,c,v,f,p;(i.moving||i.resizing)&&(t.stopPropagation(),t.preventDefault(),l=r.get(`config.chart.items.${o.item.id}`),c=r.get(`config.chart.items.${o.item.id}.rowId`),v=r.get(`config.list.rows.${c}`),f=r.get("_internal.chart.time.zoom"),p=r.get("_internal.chart.time.timePerPixel"));const h=function(t){let i=e.moveable;return t.item.hasOwnProperty("moveable")&&i&&(i=t.item.moveable),t.row.hasOwnProperty("moveable")&&i&&(i=t.row.moveable),i}(o);if(i.moving){if((!0===h||"x"===h||Array.isArray(h)&&h.includes(c))&&function(t,e,i,n,s){const a=m(o),l=t.clientX-a.ganttLeft;d(o,t);const c=r.get("_internal.chart.time.leftGlobal")+l*s-i.time.start,v=i.time.start,f=u(o)(i.time.start,c,i)-v,p=w(e.id,i.id,i.time.start+f,i.time.end+f);f&&!p&&r.update(`config.chart.items.${o.item.id}.time`,(function(t){return t.start+=f,t.end=g(o)(t.end,f,i)-1,t}))}(n,v,l,0,p),!h||"x"===h)return;let t=function(t,e,i,n,s){d(o,t);const a=m(o),l=t.clientY-a.ganttTop,c=r.get("_internal.list.visibleRows");let u=0;for(const t of c){if(t.top>l)return u>0?u-1:0;u++}return u}(n);const e=r.get("_internal.list.visibleRows");void 0===e[t]&&(t>0?t=e.length-1:t<0&&(t=0));const i=e[t],s=i.id,a=w(s,l.id,l.time.start,l.time.end);s===l.rowId||a||Array.isArray(h)&&!h.includes(s)||i.hasOwnProperty("moveable")&&!i.moveable||r.update(`config.chart.items.${l.id}.rowId`,s)}else!i.resizing||void 0!==l.resizable&&!0!==l.resizable||function(t,e,i,n,s){if(!a(o))return;const l=r.get("_internal.chart.time"),d=m(o),c=t.clientX-d.ganttLeft,v=l.leftGlobal+c*s-i.time.end;if(i.time.end+v<i.time.start)return;const f=i.time.end,p=g(o)(i.time.end,v,i)-1-f,h=w(e.id,i.id,i.time.start,i.time.end+p);p&&!h&&r.update(`config.chart.items.${o.item.id}.time`,t=>(t.start=u(o)(t.start,0,i),t.end=g(o)(t.end,p,i)-1,t))}(n,v,l,0,p)}function b(t){const e=m(o);if(e.moving||e.resizing||e.waiting){t.stopPropagation(),t.preventDefault(),e.moving=!1,e.waiting=!1,e.resizing=!1,l(o.item.id,e);for(const t in n)n[t].moving=!1,n[t].resizing=!1,n[t].waiting=!1,c(t)}}return a(o)?f.style.visibility="visible":f.style.visibility="hidden",t?(i.addEventListener("pointerdown",p),f.addEventListener("pointerdown",h),document.addEventListener("pointermove",y),document.addEventListener("pointerup",b)):(i.addEventListener("touchstart",p),f.addEventListener("touchstart",h),document.addEventListener("touchmove",y),document.addEventListener("touchend",b),document.addEventListener("touchcancel",b),i.addEventListener("mousedown",p),f.addEventListener("mousedown",h),document.addEventListener("mousemove",y),document.addEventListener("mouseup",b)),{update(t,e){a(e)||"visible"!==f.style.visibility?a(e)&&"hidden"===f.style.visibility&&(f.style.visibility="visible"):f.style.visibility="hidden",o=e},destroy(e,n){t?(i.removeEventListener("pointerdown",p),f.removeEventListener("pointerdown",h),document.removeEventListener("pointermove",y),document.removeEventListener("pointerup",b)):(i.removeEventListener("mousedown",p),f.removeEventListener("mousedown",h),document.removeEventListener("mousemove",y),document.removeEventListener("mouseup",b),i.removeEventListener("touchstart",p),f.removeEventListener("touchstart",h),document.removeEventListener("touchmove",y),document.removeEventListener("touchend",b),document.removeEventListener("touchcancel",b)),f.remove()}}}return function(t){t.state.update("config.actions.chart-timeline-items-row-item",t=>(t.push(o),t))}}
