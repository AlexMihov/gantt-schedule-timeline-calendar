{"version":3,"file":"DependencyLines.plugin.js","sources":["../src/plugins/DependencyLines.plugin.ts"],"sourcesContent":["/**\n * DependencyLines plugin\n *\n * @copyright Rafal Pospiech <https://neuronet.io>\n * @author    Rafal Pospiech <neuronet.io@gmail.com>\n * @package   gantt-schedule-timeline-calendar\n * @license   GPL-3.0 (https://github.com/neuronetio/gantt-schedule-timeline-calendar/blob/master/LICENSE)\n * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar\n */\n\nlet opts: Options;\nlet state, api;\nconst container = document.createElement('div');\ncontainer.style.position = 'absolute';\ncontainer.style.left = '0';\ncontainer.style.top = '0';\ncontainer.style.width = 'var(--width)';\ncontainer.style.height = 'var(--height)';\n\nexport type Type = 'straight' | 'quadratic' | 'cubic';\nexport interface Style {\n  [name: string]: string;\n}\nexport interface Options {\n  type?: Type;\n  style?: Style;\n  width?: number;\n  height?: number;\n}\n\nconst defaultOptions: Options = {\n  type: 'quadratic',\n  style: {},\n  width: 16,\n  height: 16\n};\n\nexport interface Point {\n  x: number;\n  y: number;\n}\n\nexport type Points = Point[];\n\n/**\n * Item dependency line component\n * @param vido\n * @param props\n */\nfunction ItemDependencyLine(vido, props) {\n  const { state, onDestroy, onChange, html, svg, Detach, update, StyleMap } = vido;\n  const componentName = 'chart-timeline-items-row-item-dependency';\n\n  let classNameLine, classNameHandle;\n  onDestroy(\n    state.subscribe('config.classNames', () => {\n      classNameLine = api.getClass(componentName + '-line');\n      classNameHandle = api.getClass(componentName + '-handle');\n    })\n  );\n\n  let wrapper;\n  onDestroy(\n    state.subscribe('config.wrappers.DependencyLineRightHandle', value => {\n      if (value) {\n        wrapper = value;\n      } else {\n        wrapper = function DependencyLineRightHandleWrapper(input) {\n          return input;\n        };\n      }\n    })\n  );\n\n  let shouldDetach = false;\n  const detach = new Detach(() => shouldDetach);\n\n  const styleMapHandle = new StyleMap({});\n  const styleMapLine = new StyleMap({});\n\n  let lines = [];\n  function updateLines() {\n    lines.length = 0;\n    const itemIds = props?.item?.lines || [];\n    const items = state.get('config.chart.items');\n    const rows = state.get('config.list.rows');\n    for (const itemId of itemIds) {\n      const currentItem = items[itemId];\n      if (!currentItem) continue;\n      const currentRow = rows[currentItem.rowId];\n      if (!currentRow) continue;\n      const width = Math.abs(props.width + (props.item.time.start - currentItem.time.start) / timePerPixel);\n      const height = Math.abs(props.row.top - currentRow.top) + currentRow.height;\n      const line = svg`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${width}\" height=\"${height}\" viewBox=\"0 0 ${width} ${height}\"></svg>`;\n      lines.push(line);\n    }\n  }\n\n  let timePerPixel = 1;\n  onDestroy(\n    state.subscribe('_internal.chart.time.timePerPixel', value => {\n      timePerPixel = value || 1;\n      updateLines();\n    })\n  );\n\n  onChange(function onChange(changedProps, options) {\n    if (options.leave || !changedProps) {\n      shouldDetach = true;\n      return update();\n    }\n    shouldDetach = false;\n    props = changedProps;\n    styleMapHandle.style['left'] = props.left + props.width - opts.width + 'px';\n    styleMapHandle.style['width'] = opts.width + 'px';\n    styleMapHandle.style['height'] = opts.height + 'px';\n    styleMapLine.style['left'] = props.left + props.width + 'px';\n    updateLines();\n    update();\n  });\n\n  return templateProps =>\n    wrapper(\n      html`\n        <div detach=${detach} class=${classNameLine} style=${styleMapLine}>${lines.map(line => line)}</div>\n      `,\n      { templateProps, props, vido }\n    );\n}\n\n/**\n * Dependency Lines Component\n * @param vido\n */\nfunction DependencyLinesComponent(vido) {\n  const { html, onDestroy, api, state, reuseComponents } = vido;\n\n  let className;\n  onDestroy(\n    state.subscribe('config.classNames', () => {\n      className = api.getClass('chart-timeline-dependency-lines');\n    })\n  );\n\n  let lines = [];\n  onDestroy(\n    state.subscribe('config.chart.items', items => {\n      const itemsArray = Object.values(items);\n      return reuseComponents(lines, itemsArray, item => item, ItemDependencyLine);\n    })\n  );\n\n  return templateProps =>\n    html`\n      <div class=\"${className}\">${lines.map(line => line.html())}</div>\n    `;\n}\n\nexport default function DependencyLinesPlugin(options: Options = defaultOptions) {\n  opts = { ...defaultOptions, ...options };\n\n  return function initialize(vido) {\n    state = vido.state;\n    api = vido.api;\n    const DependencyLines = vido.createComponent(DependencyLinesComponent);\n    state.update('config.wrappers.ChartTimelineGrid', gridWrapper => {\n      return function DependencyLinesGridWrapper(input, data) {\n        const output = vido.html`${input}${DependencyLines.html()}`;\n        return gridWrapper(output, data);\n      };\n    });\n    return function destroy() {\n      DependencyLines.destroy();\n    };\n  };\n}\n"],"names":[],"mappings":"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"}