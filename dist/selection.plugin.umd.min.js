!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Selection={})}(this,(function(t){"use strict";function e(t){return t&&"object"==typeof t&&t.constructor&&"Object"===t.constructor.name}const i="chart-timeline-grid-row-cell",a="chart-timeline-items-row-item";const s="config.plugin.Selection";function l(t){return Object.assign({enabled:!0,showOverlay:!0,isSelecting:!1,pointerState:"up",selectKey:"",multiKey:"shift",multipleSelection:!0,targetType:"",targetData:null,initialPosition:{x:0,y:0},currentPosition:{x:0,y:0},selectionAreaLocal:{x:0,y:0,width:0,height:0},selectionAreaGlobal:{x:0,y:0,width:0,height:0},selecting:{[a]:[],[i]:[]},selected:{[a]:[],[i]:[]},automaticallySelected:{[a]:[],[i]:[]},events:{down:null,move:null,up:null}},t)}class n{constructor(t,e){this.onDestroy=[],this.vido=t,this.state=t.state,this.api=t.api,this.merge=this.state.get("config.merge"),this.state.update(s,l(e)),this.data=l(e),this.wrapperClassName=this.api.getClass("chart-selection"),this.wrapperStyleMap=new t.StyleMap({display:"none"}),this.html=t.html,this.wrapper=this.wrapper.bind(this),this.destroy=this.destroy.bind(this),this.setWrapper(),this.onDestroy.push(this.state.subscribe("config.plugin.TimelinePointer",t=>{this.poitnerData=t,this.onPointerData()})),this.updateData(),this.onDestroy.push(this.state.subscribe(s,t=>{this.data=t})),this.onDestroy.push(this.state.subscribe("config.chart.items",t=>{this.data.selected[a]=this.data.selected[a].filter(e=>!!t[e.id]).map(e=>this.merge({},t[e.id]))},{ignore:["config.chart.items.*.$data.detached","config.chart.items.*.selected"]}))}setWrapper(){this.state.update("config.wrappers.ChartTimelineItems",t=>(this.oldWrapper||(this.oldWrapper=t),this.wrapper))}destroy(){this.state.update("config.wrappers.ChartTimelineItems",this.oldWrapper),this.oldWrapper=null,this.onDestroy.forEach(t=>t())}updateData(){this.state.update(s,Object.assign({},this.data)),this.vido.update()}modKeyPressed(t,e){switch(t){case"shift":return e.shiftKey;case"alt":return e.altKey;case"ctrl":return e.ctrlKey}}canSelect(){let t=this.data.enabled;const e=this.poitnerData.events.down;return e&&this.data.selectKey&&(t=t&&this.modKeyPressed(this.data.selectKey,e)),t}getSelectionAreaLocal(){const t={x:0,y:0,width:0,height:0},e=Object.assign({},this.poitnerData.initialPosition),i=Object.assign({},this.poitnerData.currentPosition),a=i.x-e.x,s=i.y-e.y;return a>=0?(t.x=e.x,t.width=a):(t.x=i.x,t.width=Math.abs(a)),s>=0?(t.y=e.y,t.height=s):(t.y=i.y,t.height=Math.abs(s)),t}translateAreaLocalToGlobal(t){const e=this.state.get("$data.chart.time.leftPx"),i=this.state.get("config.scroll.vertical.posPx");return Object.assign(Object.assign({},t),{x:t.x+e,y:t.y+i})}collectLinkedItems(t,e=[]){if(t.linkedWith&&t.linkedWith.length){const i=this.state.get("config.chart.items");for(const a of t.linkedWith){const t=i[a];e.includes(t)||e.push(t)}}return e}getSelected(t){let e,i=this.data.automaticallySelected[a].slice();const s=this.poitnerData.events.move,l=this.data.multiKey&&this.modKeyPressed(this.data.multiKey,s),n=this.collectLinkedItems(t,[t]);if(this.data.selected[a].find(e=>e.id===t.id))if(e=this.data.selected[a],i.find(e=>e.id===t.id)){const a=i.map(t=>t.id),s=e.find(e=>t.linkedWith.includes(e.id)&&!a.includes(e.id));i=i.filter(e=>e.id!==t.id),i.push(s)}else i=this.data.automaticallySelected[a];else e=l?[...new Set([...this.data.selected[a],...n]).values()]:n,i=n.filter(e=>e.id!==t.id);return e=e.map(t=>(t.selected=!0,t)),{selected:e,automaticallySelected:i}}isItemVerticallyInsideArea(t,e){if(!e.width||!e.height)return!1;const i=e.y+e.height,a=t.position.viewTop,s=a+t.actualHeight;return a>=e.y&&a<=i||s>=e.y&&s<=i||a>=e.y&&s<=i||a<=e.y&&s>=i}isItemHorizontallyInsideArea(t,e){if(!e.width||!e.height)return!1;const i=e.x+e.width;return t.position.actualLeft>=e.x&&t.position.actualLeft<=i||t.position.actualRight>=e.x&&t.position.actualRight<=i||t.position.actualLeft<=e.x&&t.position.actualRight>=i||t.position.actualLeft>=e.x&&t.position.actualRight<=i}getItemsUnderSelectionArea(t){const e=this.state.get("$data.chart.visibleItems"),i=this.poitnerData.events.move,s=i&&this.data.multiKey&&this.modKeyPressed(this.data.multiKey,i);let l=s?[...this.data.selected[a]]:[];const n=s?[...this.data.automaticallySelected[a]]:[];for(let i of e){i=this.merge({},i);const e=i.$data;if(this.isItemVerticallyInsideArea(e,t)&&this.isItemHorizontallyInsideArea(e,t)){l.find(t=>t.id===i.id)||l.push(i);const t=this.collectLinkedItems(i,[i]);for(let e of t)e=this.merge({},e),l.find(t=>t.id===e.id)||(l.push(e),n.push(e))}}return l=l.map(t=>(t.selected=!0,t)),{selected:l,automaticallySelected:n}}unmarkSelected(){const t=this.state.get("config.chart.items");let e=this.state.multi();for(const i in t){t[i].selected&&(e=e.update(`config.chart.items.${i}.selected`,!1))}e.done()}deselectItems(){this.unmarkSelected(),this.data.selected[a]=[],this.updateData()}selectMultipleCellsAndItems(){if(!this.canSelect())return;if(!this.data.multipleSelection)return void this.deselectItems();this.data.isSelecting=!0,this.data.selectionAreaLocal=this.getSelectionAreaLocal(),this.data.selectionAreaGlobal=this.translateAreaLocalToGlobal(this.data.selectionAreaLocal);const{selected:t,automaticallySelected:e}=this.getItemsUnderSelectionArea(this.data.selectionAreaLocal);if(this.data.automaticallySelected[a]=e,0===t.length)return this.unmarkSelected(),void(this.data.selected[a].length=0);this.data.selected[a]=t,this.unmarkSelected();let i=this.state.multi();for(const e of t)i=i.update(`config.chart.items.${e.id}.selected`,!0);i.done()}selectItemsIndividually(){if(this.data.isSelecting=!1,this.data.selectionAreaLocal=this.getSelectionAreaLocal(),this.data.currentPosition=this.poitnerData.currentPosition,this.data.initialPosition=this.poitnerData.initialPosition,!this.canSelect())return;const t=this.merge({},this.poitnerData.targetData);let{selected:e,automaticallySelected:i}=this.getSelected(t);e.length>1&&!this.data.multipleSelection&&(e=[t],i=[]),this.data.selected[a]=e,this.data.automaticallySelected[a]=i,this.unmarkSelected();let s=this.state.multi();for(const t of this.data.selected[a])s=s.update(`config.chart.items.${t.id}.selected`,!0);s.done()}onPointerData(){this.poitnerData.isMoving&&this.poitnerData.targetType===i&&this.data.rectangularSelection?this.selectMultipleCellsAndItems():this.poitnerData.isMoving&&this.poitnerData.targetType===i&&!this.data.rectangularSelection?this.deselectItems():this.poitnerData.isMoving&&this.poitnerData.targetType===a?this.selectItemsIndividually():this.poitnerData.isMoving||(this.data.isSelecting=!1),this.poitnerData.isMoving&&this.poitnerData.targetType!==i&&this.poitnerData.targetType!==a&&this.deselectItems(),this.data.events=this.poitnerData.events,this.data.pointerState=this.poitnerData.pointerState,this.data.targetType=this.poitnerData.targetType,this.data.targetData=this.poitnerData.targetData,this.updateData()}wrapper(t,e){if(!this.oldWrapper)return t;const i=this.oldWrapper(t,e);let a=!0;this.canSelect()&&this.data.isSelecting&&this.data.showOverlay&&this.data.multipleSelection&&this.data.rectangularSelection&&(this.wrapperStyleMap.style.display="block",this.wrapperStyleMap.style.left=this.data.selectionAreaLocal.x+"px",this.wrapperStyleMap.style.top=this.data.selectionAreaLocal.y+"px",this.wrapperStyleMap.style.width=this.data.selectionAreaLocal.width+"px",this.wrapperStyleMap.style.height=this.data.selectionAreaLocal.height+"px",a=!1);const s=this.html`<div class=${this.wrapperClassName} style=${this.wrapperStyleMap}></div>`;return this.html`${i}${a?null:s}`}}t.Plugin=function(t={}){return t=function(t){const e={enabled:!0,cells:!0,items:!0,rows:!1,showOverlay:!0,rectangularSelection:!0,multipleSelection:!0,canSelect:(t,e)=>e,canDeselect:()=>[]};return t=Object.assign(Object.assign({},e),t)}(t),function(i){const a=i.state.get(s);return a&&(t=function t(i,...a){const s=a.shift();if(e(i)&&e(s))for(const a in s)if(e(s[a]))"function"==typeof s[a].clone?i[a]=s[a].clone():(void 0===i[a]&&(i[a]={}),i[a]=t(i[a],s[a]));else if(Array.isArray(s[a])){i[a]=new Array(s[a].length);let l=0;for(let n of s[a])e(n)?"function"==typeof n.clone?i[a][l]=n.clone():i[a][l]=t({},n):i[a][l]=n,l++}else i[a]=s[a];return a.length?t(i,...a):i}({},t,a)),new n(i,t).destroy}},Object.defineProperty(t,"__esModule",{value:!0})}));
