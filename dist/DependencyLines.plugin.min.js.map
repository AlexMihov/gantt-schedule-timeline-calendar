{"version":3,"file":"DependencyLines.plugin.min.js","sources":["../src/plugins/DependencyLines.plugin.ts"],"sourcesContent":["/**\n * DependencyLines plugin\n *\n * @copyright Rafal Pospiech <https://neuronet.io>\n * @author    Rafal Pospiech <neuronet.io@gmail.com>\n * @package   gantt-schedule-timeline-calendar\n * @license   GPL-3.0 (https://github.com/neuronetio/gantt-schedule-timeline-calendar/blob/master/LICENSE)\n * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar\n */\n\nlet opts: Options;\nlet state, api;\nconst container = document.createElement('div');\ncontainer.style.position = 'absolute';\ncontainer.style.left = '0';\ncontainer.style.top = '0';\ncontainer.style.width = 'var(--width)';\ncontainer.style.height = 'var(--height)';\n\nexport type Type = 'straight' | 'quadratic' | 'cubic';\nexport interface Style {\n  [name: string]: string;\n}\nexport interface Options {\n  type?: Type;\n  style?: Style;\n  width?: number;\n  height?: number;\n}\n\nconst defaultOptions: Options = {\n  type: 'quadratic',\n  style: {},\n  width: 16,\n  height: 16\n};\n\nexport interface Point {\n  x: number;\n  y: number;\n}\n\nexport type Points = Point[];\n\n/**\n * Item dependency line component\n * @param vido\n * @param props\n */\nfunction ItemDependencyLine(vido, props) {\n  const { state, onDestroy, onChange, html, svg, Detach, update, StyleMap } = vido;\n  const componentName = 'chart-timeline-items-row-item-dependency';\n\n  let classNameLine, classNameHandle;\n  onDestroy(\n    state.subscribe('config.classNames', () => {\n      classNameLine = api.getClass(componentName + '-line');\n      classNameHandle = api.getClass(componentName + '-handle');\n    })\n  );\n\n  let wrapper;\n  onDestroy(\n    state.subscribe('config.wrappers.DependencyLineRightHandle', value => {\n      if (value) {\n        wrapper = value;\n      } else {\n        wrapper = function DependencyLineRightHandleWrapper(input) {\n          return input;\n        };\n      }\n    })\n  );\n\n  let shouldDetach = false;\n  const detach = new Detach(() => shouldDetach);\n\n  const styleMapHandle = new StyleMap({});\n  const styleMapLine = new StyleMap({});\n\n  let lines = [];\n  function updateLines() {\n    lines.length = 0;\n    const itemIds = props?.item?.lines || [];\n    const items = state.get('config.chart.items');\n    const rows = state.get('config.list.rows');\n    for (const itemId of itemIds) {\n      const currentItem = items[itemId];\n      if (!currentItem) continue;\n      const currentRow = rows[currentItem.rowId];\n      if (!currentRow) continue;\n      const width = Math.abs(props.width + (props.item.time.start - currentItem.time.start) / timePerPixel);\n      const height = Math.abs(props.row.top - currentRow.top) + currentRow.height;\n      const line = svg`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${width}\" height=\"${height}\" viewBox=\"0 0 ${width} ${height}\"></svg>`;\n      lines.push(line);\n    }\n  }\n\n  let timePerPixel = 1;\n  onDestroy(\n    state.subscribe('_internal.chart.time.timePerPixel', value => {\n      timePerPixel = value || 1;\n      updateLines();\n    })\n  );\n\n  onChange(function onChange(changedProps, options) {\n    if (options.leave || !changedProps) {\n      shouldDetach = true;\n      return update();\n    }\n    shouldDetach = false;\n    props = changedProps;\n    styleMapHandle.style['left'] = props.left + props.width - opts.width + 'px';\n    styleMapHandle.style['width'] = opts.width + 'px';\n    styleMapHandle.style['height'] = opts.height + 'px';\n    styleMapLine.style['left'] = props.left + props.width + 'px';\n    updateLines();\n    update();\n  });\n\n  return templateProps =>\n    wrapper(\n      html`\n        <div detach=${detach} class=${classNameLine} style=${styleMapLine}>${lines.map(line => line)}</div>\n      `,\n      { templateProps, props, vido }\n    );\n}\n\n/**\n * Dependency Lines Component\n * @param vido\n */\nfunction DependencyLinesComponent(vido) {\n  const { html, onDestroy, api, state, reuseComponents } = vido;\n\n  let className;\n  onDestroy(\n    state.subscribe('config.classNames', () => {\n      className = api.getClass('chart-timeline-dependency-lines');\n    })\n  );\n\n  let lines = [];\n  onDestroy(\n    state.subscribe('config.chart.items', items => {\n      const itemsArray = Object.values(items);\n      return reuseComponents(lines, itemsArray, item => item, ItemDependencyLine);\n    })\n  );\n\n  return templateProps =>\n    html`\n      <div class=\"${className}\">${lines.map(line => line.html())}</div>\n    `;\n}\n\nexport default function DependencyLinesPlugin(options: Options = defaultOptions) {\n  opts = { ...defaultOptions, ...options };\n\n  return function initialize(vido) {\n    state = vido.state;\n    api = vido.api;\n    const DependencyLines = vido.createComponent(DependencyLinesComponent);\n    state.update('config.wrappers.ChartTimelineGrid', gridWrapper => {\n      return function DependencyLinesGridWrapper(input, data) {\n        const output = vido.html`${input}${DependencyLines.html()}`;\n        return gridWrapper(output, data);\n      };\n    });\n    return function destroy() {\n      DependencyLines.destroy();\n    };\n  };\n}\n"],"names":["opts","state","api","container","document","createElement","style","position","left","top","width","height","defaultOptions","type","ItemDependencyLine","vido","props","onDestroy","onChange","html","svg","Detach","update","StyleMap","componentName","classNameLine","classNameHandle","wrapper","subscribe","getClass","value","DependencyLineRightHandleWrapper","input","shouldDetach","detach","styleMapHandle","styleMapLine","lines","updateLines","length","itemIds","item","items","get","rows","itemId","currentItem","currentRow","rowId","Math","abs","time","start","timePerPixel","row","line","push","changedProps","options","leave","templateProps","map","DependencyLinesComponent","reuseComponents","className","itemsArray","Object","values","DependencyLinesPlugin","initialize","DependencyLines","createComponent","gridWrapper","DependencyLinesGridWrapper","data","output","destroy"],"mappings":"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"}