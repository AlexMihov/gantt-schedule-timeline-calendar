{"version":3,"file":"Selection.plugin.js","sources":["../src/plugins/TimelinePointer.plugin.ts","../src/plugins/Selection/Wrapper.ts","../src/plugins/Selection/Selection.plugin.ts"],"sourcesContent":["/**\n * TimelinePointer plugin\n *\n * @copyright Rafal Pospiech <https://neuronet.io>\n * @author    Rafal Pospiech <neuronet.io@gmail.com>\n * @package   gantt-schedule-timeline-calendar\n * @license   AGPL-3.0 (https://github.com/neuronetio/gantt-schedule-timeline-calendar/blob/master/LICENSE)\n * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar\n */\n\nexport const CELL = 'chart-timeline-grid-row-cell';\nexport const ITEM = 'chart-timeline-items-row-item';\n\nexport interface PointerEvents {\n  down: PointerEvent | null;\n  move: PointerEvent | null;\n  up: PointerEvent | null;\n}\n\nexport interface Point {\n  x: number;\n  y: number;\n}\n\nexport interface PluginData {\n  enabled: boolean;\n  isMoving: boolean;\n  currentTarget: HTMLElement | null;\n  realTarget: HTMLElement | null;\n  targetType: 'chart-timeline-items-row-item' | 'chart-timeline-grid-row-cell' | '';\n  targetData: any | null;\n  events: PointerEvents;\n  initialPosition: Point;\n  currentPosition: Point;\n}\n\nexport function Plugin(options = { enabled: true }) {\n  let vido, api, state;\n  const pluginPath = 'config.plugin.TimelinePointer';\n\n  const classNames = {\n    cell: '',\n    item: ''\n  };\n\n  function generateEmptyData(): PluginData {\n    return {\n      enabled: options.enabled,\n      isMoving: false,\n      currentTarget: null,\n      realTarget: null,\n      targetType: '',\n      targetData: null,\n      initialPosition: { x: 0, y: 0 },\n      currentPosition: { x: 0, y: 0 },\n      events: {\n        down: null,\n        move: null,\n        up: null\n      }\n    };\n  }\n\n  let chartTimelineElement: HTMLElement;\n\n  class TimelinePointerAction {\n    private data: PluginData;\n    private unsub = [];\n\n    constructor(element) {\n      this.pointerDown = this.pointerDown.bind(this);\n      this.pointerMove = this.pointerMove.bind(this);\n      this.pointerUp = this.pointerUp.bind(this);\n      this.data = generateEmptyData();\n      element.addEventListener('pointerdown', this.pointerDown);\n      document.addEventListener('pointerup', this.pointerUp);\n      document.addEventListener('pointermove', this.pointerMove);\n      this.unsub.push(state.subscribe(pluginPath, value => (this.data = value)));\n    }\n\n    public destroy(element) {\n      element.removeEventListener('pointerdown', this.pointerDown);\n      document.removeEventListener('pointerup', this.pointerUp);\n      document.removeEventListener('pointermove', this.pointerMove);\n    }\n\n    private updateData() {\n      state.update(pluginPath, () => ({ ...this.data }));\n    }\n\n    private getRealTarget(ev: PointerEvent) {\n      let realTarget: HTMLElement = (ev.target as HTMLElement).closest('.' + classNames.item) as HTMLElement;\n      if (realTarget) {\n        return realTarget;\n      }\n      realTarget = (ev.target as HTMLElement).closest('.' + classNames.cell) as HTMLElement;\n      if (realTarget) {\n        return realTarget;\n      }\n      return null;\n    }\n\n    getRealPosition(ev: PointerEvent): Point {\n      const pos = { x: 0, y: 0 };\n      if (chartTimelineElement) {\n        const bounding = chartTimelineElement.getBoundingClientRect();\n        pos.x = ev.x - bounding.x;\n        pos.y = ev.y - bounding.y;\n      }\n      return pos;\n    }\n\n    private pointerDown(ev: PointerEvent) {\n      if (!this.data.enabled) return;\n      this.data.currentTarget = ev.target as HTMLElement;\n      this.data.realTarget = this.getRealTarget(ev);\n      if (this.data.realTarget) {\n        if (this.data.realTarget.classList.contains(classNames.item)) {\n          this.data.targetType = ITEM;\n          // @ts-ignore\n          this.data.targetData = this.data.realTarget.vido.item;\n        } else if (this.data.realTarget.classList.contains(classNames.cell)) {\n          this.data.targetType = CELL;\n          // @ts-ignore\n          this.data.targetData = this.data.realTarget.vido;\n        } else {\n          this.data.targetType = '';\n        }\n      } else {\n        this.data.targetType = '';\n        this.data.targetData = null;\n      }\n      this.data.isMoving = !!this.data.realTarget;\n      this.data.events.down = ev;\n      this.data.events.move = ev;\n      const realPosition = this.getRealPosition(ev);\n      this.data.initialPosition = realPosition;\n      this.data.currentPosition = realPosition;\n      this.updateData();\n    }\n\n    private pointerUp(ev: PointerEvent) {\n      if (!this.data.enabled) return;\n      this.data.isMoving = false;\n      this.data.events.up = ev;\n      this.data.currentPosition = this.getRealPosition(ev);\n      this.updateData();\n    }\n\n    private pointerMove(ev: PointerEvent) {\n      if (!this.data.enabled || !this.data.isMoving) return;\n      this.data.events.move = ev;\n      this.data.currentPosition = this.getRealPosition(ev);\n      this.updateData();\n    }\n  }\n\n  return function initialize(vidoInstance) {\n    vido = vidoInstance;\n    api = vido.api;\n    state = vido.state;\n    classNames.cell = api.getClass(CELL);\n    classNames.item = api.getClass(ITEM);\n    const unsub = state.subscribe('_internal.elements.chart-timeline', el => (chartTimelineElement = el));\n    state.update('config.actions.chart-timeline', timelineActions => {\n      timelineActions.push(TimelinePointerAction);\n      return timelineActions;\n    });\n    state.update(pluginPath, data => {\n      return generateEmptyData();\n    });\n\n    return function destroy() {\n      unsub();\n    };\n  };\n}\n","/**\n * Selection ChartTimeline Wrapper\n *\n * @copyright Rafal Pospiech <https://neuronet.io>\n * @author    Rafal Pospiech <neuronet.io@gmail.com>\n * @package   gantt-schedule-timeline-calendar\n * @license   AGPL-3.0 (https://github.com/neuronetio/gantt-schedule-timeline-calendar/blob/master/LICENSE)\n * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar\n */\n\nimport { PluginData } from './Selection.plugin';\n\nlet wrapped, vido, api, state, html;\nlet pluginData: PluginData;\nlet className, styleMap;\n\n// this function will be called at each rerender\nfunction ChartTimelineWrapper(input, props) {\n  const oldContent = wrapped(input, props);\n  if (pluginData.isSelecting) {\n    styleMap.style.display = 'block';\n    styleMap.style.left = pluginData.selectionArea.x + 'px';\n    styleMap.style.top = pluginData.selectionArea.y + 'px';\n    styleMap.style.width = pluginData.selectionArea.width + 'px';\n    styleMap.style.height = pluginData.selectionArea.height + 'px';\n  } else {\n    styleMap.style.display = 'none';\n  }\n  const SelectionRectangle = html`\n    <div class=${className} style=${styleMap}></div>\n  `;\n  return html`\n    ${oldContent}${SelectionRectangle}\n  `;\n}\n\nexport function Wrap(oldWrapper, vidoInstance) {\n  wrapped = oldWrapper;\n  vido = vidoInstance;\n  api = vido.api;\n  state = vido.state;\n  html = vido.html;\n  className = api.getClass('chart-selection');\n  styleMap = new vido.StyleMap({ display: 'none' });\n\n  vido.onDestroy(\n    state.subscribe('config.plugin.Selection', (PluginData: PluginData) => {\n      pluginData = PluginData;\n      vido.update(); // rerender to update rectangle\n    })\n  );\n\n  return ChartTimelineWrapper;\n}\n","/**\n * Selection plugin\n *\n * @copyright Rafal Pospiech <https://neuronet.io>\n * @author    Rafal Pospiech <neuronet.io@gmail.com>\n * @package   gantt-schedule-timeline-calendar\n * @license   AGPL-3.0 (https://github.com/neuronetio/gantt-schedule-timeline-calendar/blob/master/LICENSE)\n * @link      https://github.com/neuronetio/gantt-schedule-timeline-calendar\n */\n\nimport { PluginData as TimelinePointerPluginData, ITEM, CELL, Point } from '../TimelinePointer.plugin';\n\nimport { Wrap } from './Wrapper';\n\nexport interface Options {\n  enabled?: boolean;\n  grid?: boolean;\n  items?: boolean;\n  rows?: boolean;\n  horizontal?: boolean;\n  vertical?: boolean;\n  selecting?: (data, type: string) => void;\n  deselecting?: (data, type: string) => void;\n  selected?: (data, type) => void;\n  deselected?: (data, type) => void;\n  canSelect?: (type, state, all) => any[];\n  canDeselect?: (type, state, all) => any[];\n}\n\nexport interface Items {\n  [key: string]: string[];\n}\n\nexport interface SelectState {\n  selecting?: Items;\n  selected?: Items;\n}\n\nfunction prepareOptions(options) {\n  const defaultOptions: Options = {\n    enabled: true,\n    grid: false,\n    items: true,\n    rows: false,\n    horizontal: true,\n    vertical: true,\n    selecting() {},\n    deselecting() {},\n    selected() {},\n    deselected() {},\n    canSelect(type, currently, all) {\n      return currently;\n    },\n    canDeselect(type, currently, all) {\n      return [];\n    }\n  };\n  options = { ...defaultOptions, ...options } as Options;\n  return options;\n}\n\nconst pluginPath = 'config.plugin.Selection';\n\nexport interface Area {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n\nexport interface Selection {\n  [ITEM]: [];\n  [CELL]: [];\n}\n\nexport interface PluginData {\n  enabled: boolean;\n  isSelecting: boolean;\n  initialPosition: Point;\n  currentPosition: Point;\n  selectionArea: Area;\n  selected: Selection;\n  selecting: Selection;\n}\n\nfunction generateEmptyData(): PluginData {\n  return {\n    enabled: true,\n    isSelecting: false,\n    initialPosition: { x: 0, y: 0 },\n    currentPosition: { x: 0, y: 0 },\n    selectionArea: { x: 0, y: 0, width: 0, height: 0 },\n    selecting: {\n      [ITEM]: [],\n      [CELL]: []\n    },\n    selected: {\n      [ITEM]: [],\n      [CELL]: []\n    }\n  };\n}\n\nclass SelectionPlugin {\n  private data: PluginData;\n  private poitnerData: TimelinePointerPluginData;\n  private vido: any;\n  private state: any;\n  private api: any;\n  private options: Options;\n  private unsub = [];\n\n  constructor(vido, options) {\n    this.vido = vido;\n    this.state = vido.state;\n    this.api = vido.api;\n    this.options = options;\n    this.data = generateEmptyData();\n    this.unsub.push(\n      this.state.subscribe('config.plugin.TimelinePointer', timelinePointerData => {\n        this.poitnerData = timelinePointerData;\n        this.onPointerData();\n      })\n    );\n    this.updateData();\n    this.unsub.push(\n      this.state.subscribe(pluginPath, value => {\n        this.data = value;\n      })\n    );\n  }\n\n  public destroy() {\n    this.unsub.forEach(unsub => unsub());\n  }\n\n  private updateData() {\n    this.state.update(pluginPath, { ...this.data });\n  }\n\n  private getItemsUnderSelectionArea() {}\n\n  private getSelectionArea(): Area {\n    const area = { x: 0, y: 0, width: 0, height: 0 };\n    const initial = { ...this.poitnerData.initialPosition };\n    const current = { ...this.poitnerData.currentPosition };\n    const width = current.x - initial.x;\n    const height = current.y - initial.y;\n    if (width >= 0) {\n      area.x = initial.x;\n      area.width = width;\n    } else {\n      area.x = current.x;\n      area.width = Math.abs(width);\n    }\n    if (height >= 0) {\n      area.y = initial.y;\n      area.height = height;\n    } else {\n      area.y = current.y;\n      area.height = Math.abs(height);\n    }\n    return area;\n  }\n\n  private onPointerData() {\n    if (this.poitnerData.isMoving) {\n      this.data.isSelecting = true;\n      this.data.selectionArea = this.getSelectionArea();\n      console.log(this.data.selectionArea);\n      const selectingItems = this.getItemsUnderSelectionArea();\n    } else if (!this.poitnerData.isMoving) {\n      this.data.isSelecting = false;\n    }\n    this.updateData();\n  }\n}\n\nexport function Plugin(options: Options = {}) {\n  options = prepareOptions(options);\n\n  return function initialize(vido) {\n    const selectionPlugin = new SelectionPlugin(vido, options);\n    vido.state.update(pluginPath, generateEmptyData());\n    vido.state.update('config.wrappers.ChartTimelineItems', oldWrapper => {\n      return Wrap(oldWrapper, vido);\n    });\n    return function destroy() {\n      selectionPlugin.destroy();\n    };\n  };\n}\n"],"names":[],"mappings":"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"}